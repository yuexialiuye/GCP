# 第十一周
## cloud router
不需要搭配internal ip即可跟外部連線，提高安全性
````
創建一台虛擬機，HTTP不需要打勾，Network interfaces裡的External IPv4 address選擇None
進入Network Services頁面，選擇左側Cloud NAT
Get Started
Name:default-nat
Network:default
Region:asia-east1(Taiwan)
Cloud Router
Create a route
Name:default-router
Create
Create
虛擬機SSH即可連線
````
<img src="../pic/1119.png">

## Monitoring
查看監測
````
創建虛擬機vm-tw，貼上
#! /bin/bash
 apt update
 apt -y install apache2
 cat <<EOF > /var/www/html/index.html
 <html><body><p>Linux startup script added directly. $(hostname -I) </p></body></html>

測試網頁可否出現Apache2
點進虛擬機vm-tw，第2個選項Observability，選擇Last 15 minutes
點擊左邊Install ops agent
````
把監測結果發至郵箱
````
進入Monitoring，左側Alerting
Edit notification channels
修改Email
````
使用 Ops Agent 收集 Apache Web 服務器指標
https://cloud.google.com/monitoring/monitor-compute-engine-virtual-machine?hl=zh-cn#install_apache_server
````
SSH連線vm-tw，直接貼上下面指令後按Enter

# Configures Ops Agent to collect telemetry from the app and restart Ops Agent.

set -e

# Create a back up of the existing file so existing configurations are not lost.
sudo cp /etc/google-cloud-ops-agent/config.yaml /etc/google-cloud-ops-agent/config.yaml.bak

# Configure the Ops Agent.
sudo tee /etc/google-cloud-ops-agent/config.yaml > /dev/null << EOF
metrics:
  receivers:
    apache:
      type: apache
  service:
    pipelines:
      apache:
        receivers:
          - apache
logging:
  receivers:
    apache_access:
      type: apache_access
    apache_error:
      type: apache_error
  service:
    pipelines:
      apache:
        receivers:
          - apache_access
          - apache_error
EOF

sudo service google-cloud-ops-agent restart
sleep 60
````
````
另開一台SSH，貼上
timeout 120 bash -c -- 'while true; do curl localhost; sleep $((RANDOM % 4)) ; done'
點進vm-tw，Observability
點擊下面Monitor vm Instances
點擊左上VM Instances旁的上一頁箭頭

````



